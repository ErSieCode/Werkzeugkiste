<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defekt Dokumentation</title>
    
    <!-- Externe Bibliotheken für die PDF-Erstellung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* CSS ist unverändert und vollständig */
        :root {
            --primary-color: #005A9C;
            --secondary-color: #003366;
            --accent-color: #FDB813;
            --light-gray: #f4f4f4;
            --medium-gray: #ccc;
            --dark-gray: #555;
            --text-color: #333;
            --bg-color: #ffffff;
            --danger-color: #d9534f;
            
            --risk-extremely-high-bg: #7d0000;
            --risk-high-bg: #d9534f;
            --risk-medium-bg: #f0ad4e;
            --risk-low-bg: #5cb85c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
        }

        #app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            text-align: center;
        }
        
        .controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .lang-switcher, .main-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button, button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .button:hover, button:hover {
            background-color: #004a80;
            transform: translateY(-2px);
        }

        .button.active, button.active {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .button.danger { background-color: var(--danger-color); }
        .button.danger:hover { background-color: #c9302c; }
        .button.success { background-color: #5cb85c; }
        .button.success:hover { background-color: #4cae4c; }

        .filters {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: var(--bg-color);
            padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters select, .filters input { padding: 8px; border: 1px solid var(--medium-gray); border-radius: 5px; width: 100%; }
        #defect-list { display: grid; grid-template-columns: 1fr; gap: 15px; }

        .defect-card {
            background-color: var(--bg-color); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden; transition: box-shadow 0.3s; display: flex; flex-direction: column;
        }
        .defect-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .defect-card-header { padding: 15px; border-bottom: 1px solid var(--light-gray); }
        .defect-card-header h3 { margin: 0 0 5px 0; color: var(--secondary-color); }
        .defect-card-header .unit { font-style: italic; color: var(--dark-gray); font-size: 0.9em; }
        .defect-card-body { padding: 15px; flex-grow: 1; }
        .defect-card-body strong { color: var(--secondary-color); display: block; margin-bottom: 5px; }
        .defect-card-body p { white-space: pre-wrap; margin-top: 0; }
        .defect-card-footer { padding: 10px 15px; background-color: var(--light-gray); display: flex; justify-content: flex-end; gap: 10px; }
        
        .risk-assessment {
            padding: 5px 10px; color: white; border-radius: 15px; font-size: 0.8em; font-weight: bold;
            display: inline-block; margin-top: 10px; text-transform: uppercase;
        }
        .risk-extremely_high { background-color: var(--risk-extremely-high-bg); }
        .risk-high { background-color: var(--risk-high-bg); }
        .risk-medium { background-color: var(--risk-medium-bg); }
        .risk-low { background-color: var(--risk-low-bg); }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: var(--bg-color); margin: 5% auto; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 800px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slide-down 0.4s ease-out; max-height: 85vh; overflow-y: auto;
        }
        @keyframes slide-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close {
            color: var(--dark-gray); position: absolute; top: 10px; right: 20px; font-size: 30px;
            font-weight: bold; cursor: pointer; z-index: 10;
        }
        .modal-close:hover { color: var(--danger-color); }
        .modal-form .form-group { margin-bottom: 15px; }
        .modal-form label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-color); }
        .modal-form input[type="text"], .modal-form select, .modal-form textarea {
            width: 100%; padding: 10px; border: 1px solid var(--medium-gray); border-radius: 5px; box-sizing: border-box;
        }
        .modal-form textarea { min-height: 120px; resize: vertical; }
        #photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .photo-preview { position: relative; }
        .photo-preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; border: 2px solid var(--medium-gray); }
        .delete-photo-btn {
            position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white;
            border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold;
            line-height: 22px; text-align: center; font-size: 14px;
        }
        
        .signature-pad { 
            border: 2px solid var(--medium-gray); 
            border-radius: 5px; 
            cursor: crosshair; 
            touch-action: none; 
            background-color: #fff; 
            display: block;
            width: 100%;
            max-width: 400px;
            height: 150px;
        }
        .signature-container { 
            margin-bottom: 20px; 
        }
        .signature-container h4 { 
            margin-bottom: 5px; 
        }
        .signature-actions { 
            margin-top: 5px; 
        }
        
        .loader-overlay {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center;
        }
        .loader {
            border: 8px solid var(--light-gray); border-top: 8px solid var(--primary-color); border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .stats-section {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background: var(--light-gray);
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--dark-gray);
        }

        @media (min-width: 768px) {
            header { flex-direction: row; justify-content: space-between; align-items: center; }
            header h1 { text-align: left; }
            .filters { flex-direction: row; gap: 20px; }
            .filters .form-group { flex: 1; }
            #defect-list { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1200px) { #defect-list { grid-template-columns: repeat(3, 1fr); } }

        .modal-content {
            -webkit-overflow-scrolling: touch;
        }

        .photos-in-card {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .photos-in-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid var(--medium-gray);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photos-in-card img:hover {
            transform: scale(1.1);
            z-index: 10;
            position: relative;
        }

        .photo-count {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background-color: var(--light-gray);
            border: 1px solid var(--medium-gray);
            border-radius: 3px;
            font-size: 0.8em;
            color: var(--dark-gray);
            text-align: center;
        }

        .photo-preview {
            position: relative;
            display: inline-block;
            margin: 5px;
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid var(--medium-gray);
            display: block;
        }

        .delete-photo-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
            text-align: center;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: background-color 0.2s;
        }

        .delete-photo-btn:hover {
            background-color: #c9302c;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .photos-in-card { gap: 3px; }
            .photos-in-card img { width: 50px; height: 50px; }
            .photo-count { width: 50px; height: 50px; font-size: 0.7em; }
            .photo-preview img { width: 80px; height: 80px; }
            .delete-photo-btn { width: 24px; height: 24px; font-size: 14px; top: -6px; right: -6px; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1 data-lang-key="appTitle">Defekt Dokumentation</h1>
            <div class="controls-container">
                <div class="lang-switcher">
                    <button id="lang-de" class="button active">DE</button>
                    <button id="lang-en" class="button">EN</button>
                    <button id="lang-no" class="button">NO</button>
                </div>
                <div class="main-actions">
                    <button id="add-defect-btn" class="button success" data-lang-key="addDefect">Mangel hinzufügen</button>
                    <button id="generate-pdf-btn" class="button accent" data-lang-key="generatePdf">PDF Protokoll</button>
                </div>
            </div>
        </header>

        <div class="stats-section">
            <h3 data-lang-key="statistics">Statistiken</h3>
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <div class="filters">
            <div class="form-group">
                <label for="filter-category" data-lang-key="filterCategory">Kategorie</label>
                <select id="filter-category">
                    <option value="all" data-lang-key="all">Alle</option>
                    <option value="boat" data-lang-key="boat">Boot</option>
                    <option value="house" data-lang-key="house">Unterkunft</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-risk" data-lang-key="filterRisk">Risiko</label>
                <select id="filter-risk">
                    <option value="all" data-lang-key="all">Alle</option>
                    <option value="extremely_high" data-lang-key="riskExtremelyHigh">Extrem hoch</option>
                    <option value="high" data-lang-key="riskHigh">Hoch</option>
                    <option value="medium" data-lang-key="riskMedium">Mittel</option>
                    <option value="low" data-lang-key="riskLow">Niedrig</option>
                </select>
            </div>
        </div>

        <main id="defect-list"></main>
    </div>

    <!-- Modale und Overlays (HTML unverändert) -->
    <div id="defect-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h2 id="modal-title">Mangel bearbeiten</h2>
            <form id="defect-form" class="modal-form" novalidate>
                <input type="hidden" id="defect-id">
                <div class="form-group">
                    <label for="defect-category" data-lang-key="category">Kategorie</label>
                    <select id="defect-category" required>
                        <option value="boat" data-lang-key="boat">Boot</option>
                        <option value="house" data-lang-key="house">Unterkunft</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="defect-risk" data-lang-key="risk">Risikobewertung</label>
                    <select id="defect-risk" required>
                        <option value="low" data-lang-key="riskLow">Niedrig</option>
                        <option value="medium" data-lang-key="riskMedium">Mittel</option>
                        <option value="high" data-lang-key="riskHigh">Hoch</option>
                        <option value="extremely_high" data-lang-key="riskExtremelyHigh">Extrem hoch</option>
                    </select>
                </div>
                <hr>
                <h3 data-lang-key="germanContent">Deutsche Inhalte</h3>
                <div class="form-group">
                    <label for="defect-title-de" data-lang-key="title">Titel</label>
                    <input type="text" id="defect-title-de" required>
                </div>
                <div class="form-group">
                    <label for="defect-unit-de" data-lang-key="affectedUnit">Betroffene Einheit</label>
                    <input type="text" id="defect-unit-de">
                </div>
                <div class="form-group">
                    <label for="defect-desc-de" data-lang-key="description">Beschreibung</label>
                    <textarea id="defect-desc-de" required></textarea>
                </div>
                <div class="form-group">
                    <label for="defect-impl-de" data-lang-key="implications">Implikationen & Risikobewertung</label>
                    <textarea id="defect-impl-de" required></textarea>
                </div>
                <hr>
                <h3 data-lang-key="englishContent">Englische Inhalte</h3>
                <div class="form-group">
                    <label for="defect-title-en" data-lang-key="title">Titel</label>
                    <input type="text" id="defect-title-en" required>
                </div>
                <div class="form-group">
                    <label for="defect-unit-en" data-lang-key="affectedUnit">Betroffene Einheit</label>
                    <input type="text" id="defect-unit-en">
                </div>
                <div class="form-group">
                    <label for="defect-desc-en" data-lang-key="description">Beschreibung</label>
                    <textarea id="defect-desc-en" required></textarea>
                </div>
                <div class="form-group">
                    <label for="defect-impl-en" data-lang-key="implications">Implikationen & Risikobewertung</label>
                    <textarea id="defect-impl-en" required></textarea>
                </div>
                <hr>
                <h3 data-lang-key="norwegianContent">Norwegische Inhalte</h3>
                <div class="form-group">
                    <label for="defect-title-no" data-lang-key="title">Titel</label>
                    <input type="text" id="defect-title-no" required>
                </div>
                <div class="form-group">
                    <label for="defect-unit-no" data-lang-key="affectedUnit">Betroffene Einheit</label>
                    <input type="text" id="defect-unit-no">
                </div>
                <div class="form-group">
                    <label for="defect-desc-no" data-lang-key="description">Beschreibung</label>
                    <textarea id="defect-desc-no" required></textarea>
                </div>
                <div class="form-group">
                    <label for="defect-impl-no" data-lang-key="implications">Implikationen & Risikobewertung</label>
                    <textarea id="defect-impl-no" required></textarea>
                </div>
                <hr>
                <div class="form-group">
                    <label for="photo-upload" data-lang-key="addPhotos">Fotos hinzufügen</label>
                    <input type="file" id="photo-upload" multiple accept="image/*">
                    <div id="photo-preview-container"></div>
                </div>
                <button type="submit" class="button success" data-lang-key="save">Speichern</button>
            </form>
        </div>
    </div>
    
    <div id="pdf-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="pdf-modal-close-btn">&times;</span>
            <h2 data-lang-key="protocolAndSignature">Protokoll & Unterschrift</h2>
            <div class="signature-container">
                <h4 data-lang-key="landlordSignature">Unterschrift Vermieter</h4>
                <canvas id="signature-landlord" class="signature-pad"></canvas>
                <div class="signature-actions">
                    <button id="clear-landlord-sig" class="button danger" data-lang-key="clear">Löschen</button>
                </div>
            </div>
            <div class="signature-container">
                <h4 data-lang-key="tenantSignature">Unterschrift Mieter</h4>
                <canvas id="signature-tenant" class="signature-pad"></canvas>
                <div class="signature-actions">
                    <button id="clear-tenant-sig" class="button danger" data-lang-key="clear">Löschen</button>
                </div>
            </div>
            <button id="confirm-generate-pdf" class="button success" data-lang-key="createPdfNow">PDF jetzt erstellen</button>
        </div>
    </div>
    
    <div id="loader-overlay" class="loader-overlay">
        <div class="loader"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const uiTexts = {
        de: { appTitle: "Defekt Dokumentation", addDefect: "Mangel hinzufügen", generatePdf: "PDF Protokoll", filterCategory: "Kategorie", filterRisk: "Risiko", all: "Alle", boat: "Boot", house: "Unterkunft", riskExtremelyHigh: "Extrem hoch", riskHigh: "Hoch", riskMedium: "Mittel", riskLow: "Niedrig", edit: "Bearbeiten", delete: "Löschen", description: "Detaillierte Beschreibung", implications: "Implikationen und Risikobewertung", category: "Kategorie", risk: "Risikobewertung", title: "Titel", affectedUnit: "Betroffene Einheit", germanContent: "Deutsche Inhalte", englishContent: "Englische Inhalte", norwegianContent: "Norwegische Inhalte", addPhotos: "Fotos", save: "Speichern", newDefect: "Neuer Mangel", editDefect: "Mangel bearbeiten", confirmDelete: "Möchten Sie diesen Mangel wirklich löschen?", protocolAndSignature: "Protokoll & Unterschrift", landlordSignature: "Unterschrift Vermieter", tenantSignature: "Unterschrift Mieter", clear: "Löschen", createPdfNow: "PDF jetzt erstellen", reportTitle: "Mängelprotokoll", page: "Seite", of: "von", date: "Datum", statistics: "Statistiken", totalDefects: "Gesamt Mängel", extremelyHighRisk: "Extrem hohes Risiko", highRisk: "Hohes Risiko", mediumRisk: "Mittleres Risiko", lowRisk: "Niedriges Risiko", boatDefects: "Boot Mängel", houseDefects: "Unterkunft Mängel" },
        en: { appTitle: "Defect Documentation", addDefect: "Add Defect", generatePdf: "PDF Report", filterCategory: "Category", filterRisk: "Risk", all: "All", boat: "Boat", house: "Accommodation", riskExtremelyHigh: "Extremely High", riskHigh: "High", riskMedium: "Medium", riskLow: "Low", edit: "Edit", delete: "Delete", description: "Detailed Description", implications: "Implications and Risk Assessment", category: "Category", risk: "Risk Assessment", title: "Title", affectedUnit: "Affected Unit", germanContent: "German Content", englishContent: "English Content", norwegianContent: "Norwegian Content", addPhotos: "Photos", save: "Save", newDefect: "New Defect", editDefect: "Edit Defect", confirmDelete: "Are you sure you want to delete this defect?", protocolAndSignature: "Report & Signature", landlordSignature: "Landlord's Signature", tenantSignature: "Tenant's Signature", clear: "Clear", createPdfNow: "Create PDF Now", reportTitle: "List of Defects", page: "Page", of: "of", date: "Date", statistics: "Statistics", totalDefects: "Total Defects", extremelyHighRisk: "Extremely High Risk", highRisk: "High Risk", mediumRisk: "Medium Risk", lowRisk: "Low Risk", boatDefects: "Boat Defects", houseDefects: "Accommodation Defects" },
        no: { appTitle: "Dokumentasjon av mangler", addDefect: "Legg til mangel", generatePdf: "PDF-rapport", filterCategory: "Kategori", filterRisk: "Risiko", all: "Alle", boat: "Båt", house: "Bolig", riskExtremelyHigh: "Ekstremt høy", riskHigh: "Høy", riskMedium: "Middels", riskLow: "Lav", edit: "Rediger", delete: "Slett", description: "Detaljert beskrivelse", implications: "Implikasjoner og risikovurdering", category: "Kategori", risk: "Risikovurdering", title: "Tittel", affectedUnit: "Berørt enhet", germanContent: "Tysk innhold", englishContent: "Engelsk innhold", norwegianContent: "Norsk innhold", addPhotos: "Bilder", save: "Lagre", newDefect: "Ny mangel", editDefect: "Rediger mangel", confirmDelete: "Er du sikker på at du vil slette denne mangelen?", protocolAndSignature: "Rapport & signatur", landlordSignature: "Utleiers signatur", tenantSignature: "Leietakers signatur", clear: "Fjern", createPdfNow: "Opprett PDF nå", reportTitle: "Mangelliste", page: "Side", of: "av", date: "Dato", statistics: "Statistikk", totalDefects: "Totale mangler", extremelyHighRisk: "Ekstremt høy risiko", highRisk: "Høy risiko", mediumRisk: "Middels risiko", lowRisk: "Lav risiko", boatDefects: "Båtmangler", houseDefects: "Boligmangler" }
    };

    let state = { 
        defects: [], 
        currentLanguage: 'de', 
        filters: { category: 'all', risk: 'all' }, 
        currentEditId: null, 
        currentEditPhotos: []
    };

    const initialDefects = [
        { id: 'boat_1_engine', category: 'boat', risk: 'extremely_high', photos: [], content: { de: { title: 'Motorausfall auf See', unit: 'Boot 7', description: 'Am ersten Angeltag kam es zu einem Totalausfall des Motors mitten im Schärengarten. Der Motor ließ sich nicht mehr starten. Die Rettung aus dieser potenziell lebensbedrohlichen Lage erfolgte nur durch Zufall, als das zweite Boot unserer Gruppe uns zurück in den Hafen schleppen konnte. Der Vermieter (Mario) deklarierte den Vorfall als Bedienungsfehler, obwohl er diesen spezifischen Fehler während der Bootseinweisung nicht erwähnt hatte. Er räumte jedoch ein, dass dieses Problem in der Vergangenheit bereits häufiger aufgetreten sei. Zurück im Hafen startete der Motor zunächst wieder, fiel aber nach kurzem Lauf erneut aus. Eine anschließende, vom Vermieter durchgeführte Wartung wurde mit der Aussage abgeschlossen, der Motor sei nun in Ordnung.', implications: 'Sicherheitsrisiko (Extrem hoch): Ein Motorausfall auf offener See, insbesondere in einem felsigen Schärengarten, stellt eine unmittelbare Lebensgefahr dar. Das Boot ist manövrierunfähig und den Elementen (Wind, Wellen, Strömung) schutzlos ausgeliefert. Es besteht akute Gefahr, auf Felsen getrieben zu werden oder mit anderen Wasserfahrzeugen zu kollidieren.\n\nHaftungsrechtliche Aspekte: Die Aussage des Vermieters, es handele sich um einen bekannten, häufiger auftretenden Fehler, stellt eine grobe Fahrlässigkeit dar. Er hat wissentlich ein Boot mit einem potenziell lebensgefährlichen Mangel vermietet, ohne den Mieter umfassend aufzuklären. Seine nachträgliche Behauptung eines Bedienungsfehlers erscheint als Versuch, die Verantwortung abzuwälzen.\n\nFunktionale Beeinträchtigung: Der Vorfall führte zum Verlust eines halben Nutzungstages und zu erheblichem Stress und Unsicherheit für die restliche Mietdauer.' }, en: { title: 'Engine Failure at Sea', unit: 'Boat 7', description: 'On the first day of fishing, there was a total failure of the engine in the middle of the archipelago. The engine would not restart. Rescue from this potentially life-threatening situation occurred only by chance when the second boat in our group was able to tow us back to the harbor. The owner (Mario) attributed the incident to an operational error, even though he had not mentioned this specific issue during the boat safety briefing. However, he did admit that this problem had occurred frequently in the past. Back in the harbor, the engine started initially but then failed again shortly after. A subsequent maintenance check performed by the owner was concluded with the statement that the engine was now okay.', implications: "Safety Risk (Extremely High): An engine failure on the open sea, especially in a rocky archipelago, constitutes an immediate threat to life. The boat becomes unmanoverable and is helplessly exposed to the elements (wind, waves, currents). There is an acute danger of being driven onto rocks or colliding with other vessels.\n\nLiability Aspects: The owner's admission that this was a known, frequently occurring issue constitutes gross negligence. He knowingly rented out a boat with a potentially life-threatening defect without fully informing the renter. His subsequent claim of an operational error appears to be an attempt to shift responsibility.\n\nFunctional Impairment: The incident resulted in the loss of half a day's use and caused considerable stress and uncertainty for the remainder of the rental period." }, no: { title: 'Motorstans på sjøen', unit: 'Båt 7', description: 'På den første fiskedagen oppstod det en total motorstans midt i skjærgården. Motoren lot seg ikke starte igjen. Redningen fra denne potensielt livstruende situasjonen skjedde kun ved en tilfeldighet da vår andre båt kunne slepe oss tilbake til havnen. Utleier (Mario) forklarte hendelsen som en betjeningsfeil, selv om han ikke hadde nevnt denne spesifikke feilen under sikkerhetsinstruksjonen for båten. Han innrømmet imidlertid at dette problemet hadde oppstått hyppig tidligere. Tilbake i havnen startet motoren først, men stoppet igjen kort tid etter. Et påfølgende vedlikehold utført av utleier ble avsluttet med utsagnet om at motoren nå var i orden.', implications: 'Sikkerhetsrisiko (Ekstremt høy): En motorstans på åpent hav, spesielt i en steinete skjærgård, utgjør en umiddelbar livsfare. Båten blir manøvreringsudyktig og er forsvarsløs mot elementene (vind, bølger, strøm). Det er akutt fare for å drive på skjær eller kollidere med andre fartøy.\n\nAnsvarsforhold: Utleiers uttalelse om at dette var en kjent, hyppig forekommende feil, utgjør grov uaktsomhet. Han har bevisst leid ut en båt med en potensielt livsfarlig mangel uten å informere leietakeren fullt ut. Hans påfølgende påstand om en betjeningsfeil fremstår som et forsøk på å fraskrive seg ansvaret.\n\nFunktionell svekkelse: Hendelsen førte til tap av en halv dags brukstid og betydelig stress og usikkerhet for resten av leieperioden.' } } },
        { id: 'boat_2_fuel_line', category: 'boat', risk: 'extremely_high', photos: [], content: { de: { title: 'Spröde und undichte Kraftstoffleitung', unit: 'Boot 4', description: 'Die Kraftstoffleitung war offensichtlich nicht gewartet worden. Sie war derart porös und spröde, dass während der Fahrt Kraftstoff austrat. Dies zwang zum sofortigen Abbruch der Tour und zur Rückkehr in den Hafen.', implications: 'Sicherheitsrisiko (Extrem hoch): Auslaufender Kraftstoff im Motorraum oder an Deck stellt eine akute Brand- und Explosionsgefahr dar. Ein einziger Funke (z.B. von der Bordelektrik) könnte eine Katastrophe auslösen. Zudem sind die Benzindämpfe gesundheitsschädlich.\n\nUmweltrisiko (Hoch): Auslaufender Kraftstoff gelangt ungehindert in die Umwelt und kontaminiert das Wasser, was einen erheblichen ökologischen Schaden darstellt.\n\nFunktionale Beeinträchtigung: Der Tag musste abgebrochen werden, was einen weiteren Verlust von Nutzungszeit bedeutet.\n\nHaftungsrechtliche Aspekte: Das Bereitstellen eines Bootes mit einer derart mangelhaften und gefährlichen Kraftstoffversorgung ist grob fahrlässig und ein Verstoß gegen grundlegende Sicherheitsstandards.' }, en: { title: 'Brittle and Leaking Fuel Line', unit: 'Boat 4', description: 'The fuel line had obviously not been serviced. It was so porous and brittle that fuel leaked during the trip. This forced an immediate termination of the tour and a return to the harbor.', implications: 'Safety Risk (Extremely High): Leaking fuel in the engine compartment or on deck poses an acute risk of fire and explosion. A single spark (e.g., from the onboard electronics) could trigger a catastrophe. Furthermore, the gasoline fumes are harmful to health.\n\nEnvironmental Risk (High): Leaking fuel enters the environment unimpeded, contaminating the water and causing significant ecological damage.\n\nFunctional Impairment: The day\'s tour had to be aborted, resulting in another loss of usage time.\n\nLiability Aspects: Providing a boat with such a defective and dangerous fuel system is grossly negligent and a violation of fundamental safety standards.' }, no: { title: 'Sprø og lekkende drivstoffslange', unit: 'Båt 4', description: 'Drivstoffslangen hadde tydeligvis ikke blitt vedlikeholdt. Den var så porøs og sprø at det lakk drivstoff under kjøring. Dette tvang oss til å avbryte turen umiddelbart og returnere til havnen.', implications: 'Sikkerhetsrisiko (Ekstremt høy): Lekkasje av drivstoff i motorrommet eller på dekk utgjør en akutt brann- og eksplosjonsfare. En enkelt gnist (f.eks. fra båtens elektriske anlegg) kan utløse en katastrofe. I tillegg er bensindampene helseskadelige.\n\nMiljørisiko (Høy): Lekkasje av drivstoff fører til at det renner uhindret ut i miljøet og forurenser vannet, noe som utgjør en betydelig økologisk skade.\n\nFunksjonell svekkelse: Dagen måtte avbrytes, noe som medførte ytterligere tap av brukstid.\n\nAnsvarsforhold: Å stille til rådighet en båt med et så mangelfullt og farlig drivstoffsystem er grovt uaktsomt og et brudd på grunnleggende sikkerhetsstandarder.' } } },
        { id: 'boat_3_fender', category: 'boat', risk: 'medium', photos: [], content: { de: { title: 'Fehlende Fender', unit: 'Boot 4 (vollständig fehlend), Boot 6 (nur auf der rechten Seite vorhanden)', description: 'An den Booten fehlen die notwendigen Fender, um das Boot beim An- und Ablegen oder bei starkem Seegang im Hafen vor Beschädigungen zu schützen.', implications: 'Sicherheitsrisiko (Mittel): Beim Manövrieren im Hafen, insbesondere bei Wind und Wellen, besteht ohne Fender eine erhöhte Gefahr von Sachschäden am eigenen und an fremden Booten. Personen, die versuchen, das Boot mit Händen oder Füßen abzuhalten, riskieren Quetschungen und andere Verletzungen.\n\nHaftungsrechtliche Aspekte: Stellt sich die Frage, wer für Schäden haftet, die durch das Fehlen dieser Standard-Sicherheitsausrüstung entstehen. Der Vermieter kommt seiner Pflicht, ein vollständig und sicher ausgestattetes Boot zu übergeben, nicht nach.' }, en: { title: 'Missing Fenders', unit: 'Boat 4 (completely missing), Boat 6 (only present on the right side)', description: 'The boats are missing the necessary fenders to protect them from damage during mooring and casting off or in heavy seas within the harbor.', implications: "Safety Risk (Medium): When maneuvering in the harbor, especially with wind and waves, the absence of fenders creates an increased risk of property damage to one's own and other boats. Individuals trying to fend off the boat with their hands or feet risk crushing injuries and other harm.\n\nLiability Aspects: This raises the question of who is liable for damages caused by the absence of this standard safety equipment. The owner is failing to meet his obligation to provide a fully and safely equipped boat." }, no: { title: 'Manglende fendere', unit: 'Båt 4 (mangler fullstendig), Båt 6 (kun på høyre side)', description: 'Båtene mangler nødvendige fendere for å beskytte båten mot skader ved tillegging, avgang eller ved kraftig sjøgang i havnen.', implications: 'Sikkerhetsrisiko (Middels): Ved manøvrering i havnen, spesielt i vind og bølger, er det uten fendere en økt fare for materielle skader på egen og andres båter. Personer som forsøker å holde båten unna med hender eller føtter, risikerer klemskader og andre personskader.\n\nAnsvarsforhold: Det reiser spørsmål om hvem som er ansvarlig for skader som oppstår på grunn av mangelen på dette standard sikkerhetsutstyret. Utleier oppfyller ikke sin plikt til å levere en fullstendig og sikkert utstyrt båt.' } } },
        { id: 'boat_4_fire_extinguisher', category: 'boat', risk: 'extremely_high', photos: [], content: { de: { title: 'Mangelhafter Feuerlöscher', unit: 'Boot 4, Boot 6', description: 'Die vorhandenen Feuerlöscher sind so stark verrostet, dass ihre Funktionsfähigkeit im Notfall ernsthaft in Zweifel gezogen werden muss. Eine ordnungsgemäße Wartungsplakette ist nicht erkennbar.', implications: 'Sicherheitsrisiko (Extrem hoch): Ein funktionsfähiger Feuerlöscher ist eine essenzielle Sicherheitsausrüstung an Bord eines Motorbootes. Angesichts der Brandgefahr (siehe Mangel 2) ist das Fehlen eines einsatzbereiten Feuerlöschers unverantwortlich. Im Brandfall kann dies den Totalverlust des Bootes und eine akute Lebensgefahr für die Besatzung bedeuten.' }, en: { title: 'Defective Fire Extinguisher', unit: 'Boat 4, Boat 6', description: 'The existing fire extinguishers are so heavily rusted that their functionality in an emergency must be seriously questioned. A proper maintenance tag is not visible.', implications: "Safety Risk (Extremely High): A functional fire extinguisher is essential safety equipment on a motorboat. Given the risk of fire (see defect #2), the absence of a ready-to-use fire extinguisher is irresponsible. In the event of a fire, this could lead to the total loss of the boat and an acute danger to the lives of the crew." }, no: { title: 'Mangelfullt brannslukningsapparat', unit: 'Båt 4, Båt 6', description: 'De eksisterende brannslukningsapparatene er så sterkt rustne at deres funksjonalitet i en nødssituasjon må trekkes alvorlig i tvil. En gyldig serviceetikett er ikke synlig.', implications: 'Sikkerhetsrisiko (Ekstremt høy): Et funksjonsdyktig brannslukningsapparat er essensielt sikkerhetsutstyr om bord i en motorbåt. Gitt brannfaren (se mangel 2), er fraværet av et brukbart brannslukningsapparat uansvarlig. Ved brann kan dette føre til totaltap av båten og akutt livsfare for mannskapet.' } } },
        { id: 'boat_5_hooks', category: 'boat', risk: 'medium', photos: [], content: { de: { title: 'Fehlende Bootshaken', unit: 'Boot 4, Boot 6', description: 'Es sind keine Bootshaken vorhanden. Diese sind unerlässlich, um Boote im Hafen sicher zu manövrieren, Leinen aufzunehmen oder sich von Stegen abzustoßen.', implications: 'Sicherheitsrisiko (Mittel): Das Fehlen eines Bootshakens erschwert An- und Ablegemanöver erheblich und kann zu gefährlichen Situationen führen, bei denen Personen über Bord gehen oder sich verletzen könnten, während sie versuchen, das Boot manuell zu kontrollieren. Es erhöht das Risiko von Kollisionen und Sachschäden.' }, en: { title: 'Missing Boat Hooks', unit: 'Boat 4, Boat 6', description: 'There are no boat hooks available. These are essential for safely maneuvering boats in the harbor, retrieving lines, or pushing off from docks.', implications: 'Safety Risk (Medium): The lack of a boat hook makes mooring and casting off maneuvers significantly more difficult and can lead to dangerous situations where people could fall overboard or injure themselves while trying to control the boat manually. It increases the risk of collisions and property damage.' }, no: { title: 'Manglende båtshake', unit: 'Båt 4, Båt 6', description: 'Det finnes ingen båtshaker. Disse er uunnværlige for å manøvrere båter trygt i havnen, ta imot tauverk eller skyve fra brygger.', implications: 'Sikkerhetsrisiko (Middels): Mangelen på en båtshake gjør manøvrer ved tillegging og avgang betydelig vanskeligere og kan føre til farlige situasjoner der personer kan falle over bord eller skade seg i forsøket på å kontrollere båten manuelt. Det øker risikoen for kollisjoner og materielle skader.' } } },
        { id: 'boat_6_fuel_canister', category: 'boat', risk: 'high', photos: [], content: { de: { title: 'Unzureichende Kraftstoffversorgung und Haftungsfragen', unit: 'Boot 4, Boot 6', description: 'Die Anzahl der mitführbaren Kraftstoffkanister wurde auf zwei pro Boot beschränkt. In der Vergangenheit war es möglich, je nach Bedarf eine ausreichende Menge mitzunehmen. Diese neue Beschränkung ist insbesondere für längere Touren bei starkem Wellengang, der den Verbrauch massiv erhöht, nicht ausreichend. Für unerfahrene Bootsführer (die ohne Bootsführerschein fahren dürfen) ist der Mehrverbrauch kaum kalkulierbar.', implications: 'Sicherheitsrisiko (Hoch): Die Gefahr, auf offener See wegen Treibstoffmangels liegen zu bleiben, ist durch diese Regelung signifikant erhöht. Dies führt zu denselben lebensgefährlichen Situationen wie bei einem technischen Motorausfall.\n\nHaftungsrechtliche Aspekte: Wer haftet, wenn das Boot aufgrund der vom Vermieter auferlegten, unzureichenden Kraftstoffmenge in eine Notsituation gerät? Der Vermieter schafft wissentlich eine potenziell gefährliche Bedingung. Die Einhaltung der Checkliste (ausreichend Treibstoff) wird dem Mieter unmöglich gemacht.' }, en: { title: 'Insufficient Fuel Supply and Liability Issues', unit: 'Boat 4, Boat 6', description: 'The number of fuel canisters that can be carried has been limited to two per boat. In the past, it was possible to take as many as needed. This new restriction is insufficient, especially for longer trips with high waves, which drastically increase fuel consumption. For inexperienced boaters (who are allowed to operate the boats without a license), this increased consumption is nearly impossible to calculate.', implications: 'Safety Risk (High): The risk of running out of fuel on the open sea is significantly increased by this policy. This leads to the same life-threatening situations as a technical engine failure.\n\nLiability Aspects: Who is liable if the boat gets into an emergency situation due to the insufficient amount of fuel mandated by the owner? The owner is knowingly creating a potentially dangerous condition. Adherence to the checklist (sufficient fuel) is made impossible for the renter.' }, no: { title: 'Utilstrekkelig drivstofftilgang og ansvarsspørsmål', unit: 'Båt 4, Båt 6', description: 'Antallet medbrakte drivstoffkanner er begrenset til to per båt. Tidligere var det mulig å ta med så mange som nødvendig. Denne nye begrensningen er utilstrekkelig, spesielt for lengre turer i kraftig sjøgang, som øker forbruket massivt. For uerfarne båtførere (som har lov til å kjøre uten båtførerbevis) er merforbruket nesten umulig å beregne.', implications: 'Sikkerhetsrisiko (Høy): Faren for å gå tom for drivstoff på åpent hav er betydelig økt på grunn av denne regelen. Dette fører til de samme livstruende situasjonene som ved en teknisk motorstans.\n\nAnsvarsforhold: Hvem er ansvarlig dersom båten havner i en nødsituasjon på grunn av den utilstrekkelige drivstoffmengden pålagt av utleier? Utleier skaper bevisst en potensielt farlig situasjon. Leietakeren gjøres det umulig å følge sjekklisten (tilstrekkelig med drivstoff).' } } },
        { id: 'boat_7_indicator_lamp', category: 'boat', risk: 'high', photos: [], content: { de: { title: 'Dauerhaft leuchtende Motor-Warnleuchte', unit: '(Nicht spezifiziert)', description: 'Die Störungsanzeigeleuchte des Motors leuchtet permanent. Dadurch ist es unmöglich zu erkennen, ob ein neuer, akuter Fehler vorliegt oder nicht.', implications: 'Sicherheitsrisiko (Hoch): Eine Warnleuchte verliert ihren Zweck, wenn sie dauerhaft leuchtet. Der Fahrer hat keine Möglichkeit mehr, über kritische Systemfehler (z.B. Überhitzung, Öldruckverlust) informiert zu werden, bevor es zu einem kapitalen Motorschaden und einem daraus resultierenden Ausfall auf See kommt. Dies ist eine grobe Vernachlässigung der Sicherheitssysteme.' }, en: { title: 'Constantly Illuminated Engine Malfunction Indicator Lamp', unit: '(Not specified)', description: "The engine's malfunction indicator lamp is permanently on. This makes it impossible to determine whether a new, acute fault has occurred.", implications: "Safety Risk (High): A warning light loses its purpose if it is always on. The operator has no way of being alerted to critical system failures (e.g., overheating, loss of oil pressure) before a catastrophic engine failure and subsequent breakdown at sea occurs. This is a gross neglect of the boat's safety systems." }, no: { title: 'Permanent lysende motorvarsellampe', unit: '(Ikke spesifisert)', description: 'Feilindikasjonslampen for motoren lyser konstant. Dette gjør det umulig å oppdage om en ny, akutt feil har oppstått.', implications: 'Sikkerhetsrisiko (Høy): En varsellampe mister sin funksjon når den lyser permanent. Føreren har ingen mulighet til å bli varslet om kritiske systemfeil (f.eks. overoppheting, tap av oljetrykk) før det fører til en alvorlig motorhavari og påfølgende stans på sjøen. Dette er en grov forsømmelse av sikkerhetssystemene.' } } },
        { id: 'boat_8_gps', category: 'boat', risk: 'extremely_high', photos: [], content: { de: { title: 'Veraltetes und fehlerhaftes GPS-Navigationssystem', unit: 'Boot 4', description: 'Das Garmin-GPS-System ist nicht auf dem neuesten Stand. Die Kartendarstellung ist fehlerhaft und zeigt teilweise nur einen Radius von 5 Metern um das Boot korrekt an. Die Ausrichtung des Bootes auf der Karte ist oft falsch, was dazu führen kann, dass man unbemerkt in die falsche Richtung navigiert.', implications: 'Sicherheitsrisiko (Extrem hoch): In einem komplexen und felsigen Schärengarten ist eine zuverlässige Navigation überlebenswichtig. Ein fehlerhaftes GPS kann den Fahrer direkt in gefährliche, untiefe Gewässer oder gegen Felsen führen. Ohne eine eigene, funktionierende Navigations-App (z.B. auf dem Smartphone) ist die Nutzung des Bootes in diesem Gebiet lebensgefährlich.' }, en: { title: 'Outdated and Faulty GPS Navigation System', unit: 'Boat 4', description: "The Garmin GPS system is outdated. The map rendering is faulty, sometimes only displaying a 5-meter radius around the boat correctly. The boat's orientation on the map is often incorrect, which can lead to unknowingly navigating in the wrong direction.", implications: 'Safety Risk (Extremely High): In a complex and rocky archipelago, reliable navigation is vital for survival. A faulty GPS can lead the operator directly into dangerous, shallow waters or into rocks. Without a separate, functional navigation app (e.g., on a smartphone), operating the boat in this area is life-threatening.' }, no: { title: 'Utdatert og feilaktig GPS-navigasjonssystem', unit: 'Båt 4', description: 'Garmin GPS-systemet er ikke oppdatert. Kartvisningen er feilaktig og viser delvis kun en radius på 5 meter rundt båten korrekt. Båtens orientering på kartet er ofte feil, noe som kan føre til at man ubevisst navigerer i feil retning.', implications: 'Sikkerhetsrisiko (Ekstremt høy): I en kompleks og steinete skjærgård er pålitelig navigasjon livsviktig. Et feilaktig GPS kan lede føreren direkte inn i farlige, grunne farvann eller mot skjær. Uten en egen, fungerende navigasjonsapp (f.eks. på smarttelefon) er bruken av båten i dette området livsfarlig.' } } },
        { id: 'boat_9_anchor', category: 'boat', risk: 'high', photos: [], content: { de: { title: 'Fehlender oder unbrauchbarer Anker', unit: 'Boot 4, Boot 6', description: 'Der Anker fehlt entweder komplett oder ist nicht einsatzbereit (z.B. nicht mit einer Leine verbunden). Dadurch ist er im Notfall oder in Stresssituationen nutzlos.', implications: 'Sicherheitsrisiko (Hoch): Der Anker ist eine kritische Notfallausrüstung. Bei einem Motorausfall ist er oft die einzige Möglichkeit, das Boot vor dem Abtreiben auf Felsen oder in die offene See zu sichern. Sein Fehlen oder seine Unbrauchbarkeit macht eine Notsituation dramatisch gefährlicher.' }, en: { title: 'Missing or Unusable Anchor', unit: 'Boat 4, Boat 6', description: 'The anchor is either missing entirely or is not ready for use (e.g., not connected to a line). This renders it useless in an emergency or a stressful situation.', implications: 'Safety Risk (High): The anchor is a critical piece of emergency equipment. In case of an engine failure, it is often the only means to prevent the boat from drifting onto rocks or into the open sea. Its absence or unusability makes an emergency situation dramatically more dangerous.' }, no: { title: 'Manglende eller ubrukelig anker', unit: 'Båt 4, Båt 6', description: 'Ankeret mangler enten helt eller er ikke klargjort for bruk (f.eks. ikke festet til en line). Dette gjør det ubrukelig i en nødsituasjon eller stressende situasjon.', implications: 'Sikkerhetsrisiko (Høy): Ankeret er kritisk nødutstyr. Ved motorstans er det ofte den eneste måten å forhindre at båten driver på skjær eller ut på åpent hav. At det mangler eller er ubrukelig, gjør en nødssituasjon dramatisk farligere.' } } },
        { id: 'boat_10_firstaid', category: 'boat', risk: 'high', photos: [], content: { de: { title: 'Fehlender oder abgelaufener Verbandskasten', unit: 'Boot 4 (abgelaufen), Boot 6 (fehlt komplett)', description: 'Es ist entweder kein Verbandskasten vorhanden oder das Material darin ist seit langer Zeit abgelaufen.', implications: 'Sicherheitsrisiko (Hoch): Auf einem Boot, wo durch Angelhaken, Messer oder Stürze schnell Verletzungen passieren können, ist ein vollständiger und gültiger Verbandskasten gesetzlich vorgeschrieben und moralisch geboten. Fehlendes oder unsteriles Verbandsmaterial kann bei Verletzungen zu Infektionen und schweren gesundheitlichen Komplikationen führen.' }, en: { title: 'Missing or Expired First Aid Kit', unit: 'Boat 4 (expired), Boat 6 (completely missing)', description: 'There is either no first aid kit on board, or the materials inside it are long expired.', implications: 'Safety Risk (High): On a boat, where injuries from fish hooks, knives, or falls can happen quickly, a complete and up-to-date first aid kit is legally required and morally imperative. Missing or unsterile supplies can lead to infections and severe health complications in the event of an injury.' }, no: { title: 'Manglende eller utgått førstehjelpsskrin', unit: 'Båt 4 (utgått), Båt 6 (mangler fullstendig)', description: 'Det er enten ingen førstehjelpsskrin om bord, eller materiellet i det har for lengst gått ut på dato.', implications: 'Sikkerhetsrisiko (Høy): På en båt, hvor skader fra fiskekroker, kniver eller fall raskt kan oppstå, er et komplett og gyldig førstehjelpsskrin lovpålagt og moralsk påkrevd. Manglende eller usterilt utstyr kan føre til infeksjoner og alvorlige helsekomplikasjoner ved skader.' } } },
        { id: 'boat_11_fuel_gauge', category: 'boat', risk: 'high', photos: [], content: { de: { title: 'Unleserliche oder defekte Tankanzeige', unit: 'Boot 4 (stark eingetrübt), Boot 6 (Loch im Schauglas)', description: 'Die Tankanzeige ist entweder durch ein trübes Schauglas (selbst mit Brille kaum lesbar) oder durch eine Beschädigung (Loch) unbrauchbar.', implications: 'Sicherheitsrisiko (Hoch): Eine funktionierende Tankanzeige ist für die Planung einer sicheren Tour unerlässlich. Wenn der Füllstand nicht abgelesen werden kann, wird die Einschätzung des verbleibenden Kraftstoffs zum reinen Glücksspiel. Dies erhöht das Risiko, unvorhergesehen ohne Treibstoff liegen zu bleiben, massiv (siehe Mangel 6).' }, en: { title: 'Illegible or Defective Fuel Gauge', unit: 'Boat 4 (very cloudy), Boat 6 (hole in the gauge)', description: 'The fuel gauge is unusable, either due to a clouded sight glass (barely readable even with glasses) or physical damage (a hole).', implications: 'Safety Risk (High): A functioning fuel gauge is essential for planning a safe trip. If the fuel level cannot be read, estimating the remaining fuel becomes pure guesswork. This massively increases the risk of unexpectedly running out of fuel (see defect #6).' }, no: { title: 'Uleselig eller defekt tankmåler', unit: 'Båt 4 (sterkt grumsete), Båt 6 (hull i glasset)', description: 'Tankmåleren er ubrukelig, enten på grunn av et grumsete sikteglass (knapt leselig selv med briller) eller på grunn av en skade (hull).', implications: 'Sikkerhetsrisiko (Høy): En fungerende tankmåler er avgjørende for å planlegge en trygg tur. Når drivstoffnivået ikke kan leses av, blir beregningen av gjenværende drivstoff ren gjetning. Dette øker risikoen for å uforutsett gå tom for drivstoff massivt (se mangel 6).' } } },
        { id: 'boat_12_funnel', category: 'boat', risk: 'low', photos: [], content: { de: { title: 'Fehlender Trichter zum Betanken', unit: 'Boot 4, Boot 6', description: 'Es werden keine Trichter zum Betanken der Boote zur Verfügung gestellt. Die vorhandenen Kanister mit Ausgießern, denen teilweise die Entlüftung fehlt, machen ein sauberes Einfüllen unmöglich. Auf Nachfrage wurde bestätigt, dass keine Trichter vorhanden sind.', implications: 'Umweltrisiko (Hoch): Ohne Trichter ist es unvermeidlich, dass beim Betanken Benzin ins Wasser oder auf das Boot gelangt. Dies stellt eine Umweltverschmutzung dar und erhöht die Brandgefahr an Deck.\n\nKundenzufriedenheit (Niedrig): Es handelt sich hier um eine grundlegende Ausrüstung, deren Fehlen Unverständnis und Ärger auslöst. Die Lösung wäre eine Investition von wenigen Euro. Das Ignorieren dieses Problems zeugt von mangelndem Servicebewusstsein und fehlendem Umweltbewusstsein.' }, en: { title: 'No Funnel for Refueling', unit: 'Boat 4, Boat 6', description: 'No funnels are provided for refueling the boats. The existing canisters with spouts, some of which lack vents, make it impossible to refuel cleanly. When asked, the owner confirmed that he does not have any funnels.', implications: 'Environmental Risk (High): Without a funnel, it is inevitable that gasoline will be spilled into the water or onto the boat during refueling. This causes environmental pollution and increases the fire hazard on deck.\n\nCustomer Satisfaction (Low): This is basic equipment, and its absence is incomprehensible and frustrating. The solution would be an investment of a few euros. Ignoring this problem shows a lack of service orientation and environmental awareness.' }, no: { title: 'Manglende trakt for fylling av drivstoff', unit: 'Båt 4, Båt 6', description: 'Det tilbys ingen trakter for fylling av drivstoff på båtene. De eksisterende kannene med helletuter, hvorav noen mangler lufting, gjør en ren påfylling umulig. Ved forespørsel ble det bekreftet at ingen trakter er tilgjengelige.', implications: 'Miljørisiko (Høy): Uten trakt er det uunngåelig at bensin søles i vannet eller på båten under fylling. Dette utgjør en miljøforurensning og øker brannfaren på dekk.\n\nKundetilfredshet (Lav): Dette er grunnleggende utstyr, og mangelen på det skaper frustrasjon og irritasjon. Løsningen ville vært en investering på noen få kroner. Å ignorere dette problemet vitner om manglende serviceinnstilling og miljøbevissthet.' } } },
        { id: 'boat_13_storage_box', category: 'boat', risk: 'low', photos: [], content: { de: { title: 'Undichte Staukiste', unit: '(Nicht spezifiziert)', description: 'Die Staukiste vor dem Fahrerstand, die für die trockene Lagerung von Material (z.B. Kleidung, Elektronik) vorgesehen ist, ist undicht. Wasser dringt ein und durchnässt den gesamten Inhalt.', implications: 'Funktionale Beeinträchtigung: Die Kiste erfüllt ihren Zweck nicht. Wichtige Ausrüstung wie Wechselkleidung oder empfindliche Geräte können beschädigt werden. Eine einfache Silikonnaht könnte das Problem beheben, was die Untätigkeit des Vermieters umso unverständlicher macht.' }, en: { title: 'Leaking Storage Box', unit: '(Not specified)', description: 'The storage box in front of the helm, intended for keeping gear dry (e.g., clothing, electronics), is not watertight. Water gets in, soaking the entire contents.', implications: "Functional Impairment: The box fails to serve its purpose. Important equipment like spare clothes or sensitive devices can be damaged. A simple silicone seam could fix the problem, which makes the owner's inaction all the more baffling." }, no: { title: 'Lekkende stuerom', unit: '(Ikke spesifisert)', description: 'Stuerommet foran førerposisjonen, som er ment for tørr oppbevaring av utstyr (f.eks. klær, elektronikk), er utett. Vann trenger inn og gjør alt innholdet vått.', implications: 'Funksjonell svekkelse: Rommet oppfyller ikke sin funksjon. Viktig utstyr som skifteklær eller sensitive enheter kan bli ødelagt. En enkel silikonfuge kunne løst problemet, noe som gjør utleiers passivitet desto mer uforståelig.' } } },
        { id: 'house_1_fuel_service', category: 'house', risk: 'low', photos: [], content: { de: { title: '"Tank-Service" als versteckte Preiserhöhung', unit: 'Allgemein', description: 'Anstelle der früheren Möglichkeit, ausreichend Kanister mitzunehmen, gibt es nun einen "Tank-Service". Dieser besteht darin, dass der Vermieter Benzin zur Verfügung stellt, jedoch nur in Form von zwei Kanistern pro Boot. Dieser Service kostet 10 Cent pro Liter mehr als an der Tankstelle, und das Betanken muss weiterhin selbst vorgenommen werden.', implications: 'Finanzielle Aspekte / Kundenzufriedenheit: Diese Praxis kommt einem Betrug am Kunden bzw. einer "Abzocke" sehr nahe. Eine Leistung, die früher inklusive war (Bereitstellung von Kanistern), wird nun als "Service" mit einem erheblichen Preisaufschlag verkauft, ohne einen echten Mehrwert zu bieten. Dies untergräbt das Vertrauen und die Kundenzufriedenheit massiv.' }, en: { title: '"Fueling Service" as a Hidden Price Increase', unit: 'General', description: 'Instead of the previous option to take a sufficient number of fuel canisters, there is now a "fueling service." This service consists of the owner providing gasoline, but only two canisters per boat. This "service" costs 10 cents more per liter than at the gas station, and the refueling still has to be done by the renters themselves.', implications: 'Financial Aspects / Customer Satisfaction: This practice is very close to a rip-off. A provision that was previously included (availability of canisters), is now sold as a "service" with a significant markup, offering no real added value. This massively undermines trust and customer satisfaction.' }, no: { title: '"Drivstoffservice" som skjult prisøkning', unit: 'Generelt', description: 'I stedet for den tidligere muligheten til å ta med tilstrekkelig med kanner, er det nå en "drivstoffservice". Denne består i at utleier stiller bensin til rådighet, men kun i form av to kanner per båt. Denne tjenesten koster 10 cent mer per liter enn på bensinstasjonen, og fyllingen må fortsatt gjøres selv.', implications: 'Økonomiske aspekter / Kundetilfredshet: Denne praksisen grenser til lureri eller et urimelig prispåslag. En tjeneste som tidligere var inkludert (tilgang på kanner), selges nå som en "service" med et betydelig prispåslag uten å tilby noen reell merverdi. Dette undergraver tilliten og kundetilfredsheten massivt.' } } },
        { id: 'house_2_oven', category: 'house', risk: 'high', photos: [], content: { de: { title: 'Defekte Umluftfunktion am Backofen', unit: 'Raum 3', description: 'Die Umluftfunktion des Backofens fällt unregelmäßig aus, was bereits das Aufbacken von Brötchen erschwert. Zusätzlich löst der Ofen wiederholt die Sicherung aus, die dann manuell am Sicherungskasten wieder eingeschaltet werden muss.', implications: 'Sicherheitsrisiko (Mittel bis Hoch): Ein elektrisches Gerät, das ständig die Sicherung auslöst, hat einen schwerwiegenden Defekt. Es besteht Brandgefahr durch Überlastung oder Kurzschluss.\n\nHaftungsrechtliche Aspekte: Wer haftet, wenn durch dieses defekte Gerät ein Brand im Haus ausbricht? Der Vermieter wurde auf den Mangel hingewiesen.\n\nFunktionale Beeinträchtigung: Der Backofen ist nicht zuverlässig nutzbar, was die Selbstversorgung in der Ferienwohnung einschränkt.' }, en: { title: 'Defective Convection Function on Oven', unit: 'Room 3', description: "The oven's convection (circulating air) function fails intermittently, making even simple tasks like baking bread rolls difficult. Additionally, the oven repeatedly trips the circuit breaker, which must then be manually reset at the fuse box.", implications: 'Safety Risk (Medium to High): An electrical appliance that constantly trips the fuse has a serious defect. There is a risk of fire due to overload or a short circuit.\n\nLiability Aspects: Who is liable if a fire breaks out in the house due to this defective appliance? The owner has been made aware of the defect.\n\nFunctional Impairment: The oven is not reliably usable, which limits the self-catering capabilities in the holiday apartment.' }, no: { title: 'Defekt varmluftsfunksjon på stekeovn', unit: 'Rom 3', description: 'Varmluftsfunksjonen på stekeovnen svikter uregelmessig, noe som gjør selv steking av rundstykker vanskelig. I tillegg utløser ovnen gjentatte ganger sikringen, som deretter må slås på manuelt i sikringsskapet.', implications: 'Sikkerhetsrisiko (Middels til Høy): Et elektrisk apparat som stadig utløser sikringen, har en alvorlig feil. Det er brannfare på grunn av overbelastning eller kortslutning.\n\nAnsvarsforhold: Hvem er ansvarlig hvis det oppstår brann i huset på grunn av dette defekte apparatet? Utleier er blitt gjort oppmerksom på mangelen.\n\nFunksjonell svekkelse: Stekeovnen er ikke pålitelig i bruk, noe som begrenser mulighetene for selvhushold i ferieleiligheten.' } } },
        { id: 'house_3_cleaning_supplies', category: 'house', risk: 'low', photos: [], content: { de: { title: 'Fehlende Reinigungsutensilien', unit: 'Raum 3, Raum 4', description: 'Es fehlen grundlegende Reinigungsutensilien wie Besen, Kehrblech, Handfeger sowie allgemeine Reinigungsmittel.', implications: 'Hygienische Mängel / Kundenzufriedenheit: In einer Ferienwohnung wird von den Mietern erwartet, eine Grundsauberkeit zu halten. Ohne die notwendigen Utensilien ist dies unmöglich. Dies führt zu unhygienischen Zuständen während des Aufenthalts.' }, en: { title: 'Missing Cleaning Supplies', unit: 'Room 3, Room 4', description: 'Basic cleaning supplies such as a broom, dustpan, hand brush, and general cleaning products are missing.', implications: 'Hygiene Issues / Customer Satisfaction: In a holiday apartment, renters are expected to maintain a basic level of cleanliness. This is impossible without the necessary tools. This leads to unhygienic conditions during the stay.' }, no: { title: 'Manglende rengjøringsutstyr', unit: 'Rom 3, Rom 4', description: 'Det mangler grunnleggende rengjøringsutstyr som kost, feiebrett, håndkost samt generelle rengjøringsmidler.', implications: 'Hygieniske mangler / Kundetilfredshet: I en ferieleilighet forventes det at leietakerne holder en grunnleggende renslighet. Uten nødvendig utstyr er dette umulig. Dette fører til uhygieniske forhold under oppholdet.' } } },
        { id: 'house_4_dishes', category: 'house', risk: 'low', photos: [], content: { de: { title: 'Fehlendes Geschirr und Spülmaschinentabs', unit: 'Raum 3, Raum 4', description: 'Es fehlt an ausreichend Geschirr für die vorgesehene Personenzahl. Zudem werden keine Spülmaschinentabs bereitgestellt.', implications: 'Funktionale Beeinträchtigung: Die Nutzbarkeit der Küche ist eingeschränkt. Die Mieter müssen entweder ständig spülen oder eigenes Geschirr/Tabs kaufen, was bei einer voll ausgestatteten Ferienwohnung nicht erwartet wird.' }, en: { title: 'Missing Dishes and Dishwasher Tabs', unit: 'Room 3, Room 4', description: 'There are not enough dishes for the number of people the apartment is meant for. Furthermore, no dishwasher tabs are provided.', implications: 'Functional Impairment: The usability of the kitchen is limited. Renters must either wash dishes constantly or buy their own dishes/tabs, which should not be expected in a fully equipped holiday apartment.' }, no: { title: 'Manglende servise og oppvaskmaskintabletter', unit: 'Rom 3, Rom 4', description: 'Det mangler tilstrekkelig med servise for det tiltenkte antallet personer. I tillegg tilbys det ingen oppvaskmaskintabletter.', implications: 'Funksjonell svekkelse: Bruken av kjøkkenet er begrenset. Leietakerne må enten vaske opp konstant eller kjøpe eget servise/tabletter, noe som ikke forventes i en fullt utstyrt ferieleilighet.' } } },
        { id: 'house_5_door', category: 'house', risk: 'high', photos: [], content: { de: { title: 'Aufgebrochene Tür', unit: 'Raum 3', description: 'Eine Tür in der Unterkunft ist aufgebrochen. Dieser Schaden bestand bereits im Vorjahr und wurde bis heute nicht repariert.', implications: 'Sicherheitsrisiko (Hoch): Eine nicht verschließbare bzw. aufgebrochene Tür stellt ein erhebliches Sicherheitsrisiko dar. Die Privatsphäre ist nicht gewährleistet und das Eigentum der Mieter ist nicht vor Diebstahl geschützt.\n\nHaftungsrechtliche Aspekte: Wer haftet im Falle eines Diebstahls? Da der Vermieter von dem langjährigen Mangel weiß, trägt er eine erhebliche Mitverantwortung.' }, en: { title: 'Broken Door', unit: 'Room 3', description: 'A door in the accommodation is broken (appears to have been forced open). This damage already existed last year and has still not been repaired.', implications: "Security Risk (High): A door that cannot be properly closed or locked poses a significant security risk. Privacy is not guaranteed, and the renters' property is not protected from theft.\n\nLiability Aspects: Who is liable in the event of a theft? Since the owner has been aware of this long-standing defect, he bears significant co-responsibility." }, no: { title: 'Ødelagt dør', unit: 'Rom 3', description: 'En dør i boligen er brutt opp. Denne skaden eksisterte allerede i fjor og er fortsatt ikke blitt reparert.', implications: 'Sikkerhetsrisiko (Høy): En dør som ikke kan låses eller er brutt opp, utgjør en betydelig sikkerhetsrisiko. Personvernet er ikke ivaretatt, og leietakernes eiendeler er ikke beskyttet mot tyveri.\n\nAnsvarsforhold: Hvem er ansvarlig ved et eventuelt tyveri? Siden utleier har visst om den langvarige mangelen, bærer han et betydelig medansvar.' } } },
        { id: 'house_6_filleting_room', category: 'house', risk: 'extremely_high', photos: [], content: { de: { title: 'Verdreckter Filetierraum', unit: 'Allgemein', description: 'Der Raum zum Filetieren von Fischen ist extrem schmutzig. Überall im Raum – an den Wänden, unter dem Tisch und auf dem Tisch selbst – kleben alte Fischreste.', implications: 'Hygienische Mängel (Extrem hoch): Ein derart verdreckter Raum zur Verarbeitung von Lebensmitteln ist eine Brutstätte für Bakterien und Keime. Es ist gesundheitsgefährdend und unzumutbar, hier Fische zu filetieren. Der Mangel an bereitgestellten Reinigungsmitteln macht es den Crews unmöglich, den Raum selbst in einen hygienischen Zustand zu versetzen.' }, en: { title: 'Filthy Filleting Room', unit: 'General', description: 'The room for filleting fish is extremely dirty. Old fish remains are stuck everywhere in the room – on the walls, under the table, and the table itself is heavily contaminated.', implications: 'Hygiene Issues (Extremely High): A room for processing food in such a filthy state is a breeding ground for bacteria and germs. It is a health hazard and unacceptable to prepare fish here. The lack of provided cleaning supplies makes it impossible for the crews to bring the room to a hygienic state themselves.' }, no: { title: 'Skittent sløyerom', unit: 'Generelt', description: 'Rommet for filetering av fisk er ekstremt skittent. Overalt i rommet – på veggene, under bordet og på selve bordet – kleber det gamle fiskerester.', implications: 'Hygieniske mangler (Ekstremt høye): Et så skittent rom for behandling av matvarer er en grobunn for bakterier og smittestoffer. Det er helsefarlig og uakseptabelt å filetere fisk her. Mangelen på tilgjengelige rengjøringsmidler gjør det umulig for mannskapene å selv bringe rommet i en hygienisk tilstand.' } } },
        { id: 'house_7_bridge', category: 'house', risk: 'high', photos: [], content: { de: { title: 'Gebrochene Planken am Steg', unit: 'Steg vor dem Filetierraum', description: 'Die Holzplanken des Stegs vor dem Filetierraum sind teilweise gebrochen.', implications: 'Sicherheitsrisiko (Hoch): Dies stellt eine akute Unfallgefahr dar. Personen können durch die gebrochenen Planken treten, stürzen und sich dabei schwere Verletzungen (Brüche, Verstauchungen) zuziehen. Die strukturelle Integrität des Stegs ist beeinträchtigt.' }, en: { title: 'Broken Planks on the Bridge', unit: 'Bridge in front of the filleting room', description: 'The wooden planks of the bridge in front of the filleting room are partially broken.', implications: 'Safety Risk (High): This poses an acute accident hazard. People can step through the broken planks, fall, and sustain serious injuries (fractures, sprains). The structural integrity of the bridge is compromised.' }, no: { title: 'Knekte planker på bryggen', unit: 'Brygge foran sløyerommet', description: 'Treplankene på bryggen foran sløyerommet er delvis knekt.', implications: 'Sikkerhetsrisiko (Høy): Dette utgjør en akutt ulykkesfare. Personer kan tråkke gjennom de knekte plankene, falle og pådra seg alvorlige skader (brudd, forstuelser). Bryggens strukturelle integritet er svekket.' } } },
        { id: 'house_8_sink', category: 'house', risk: 'low', photos: [], content: { de: { title: 'Schlechter Wasserabfluss im Waschbecken', unit: 'Raum 4', description: 'Das Wasser im Waschbecken des Badezimmers fließt nur sehr langsam ab. Dadurch sammelt sich stehendes, schmutziges Wasser, und das Becken ist schwer zu reinigen.', implications: 'Hygienische Mängel: Ein verstopfter Abfluss ist unhygienisch und führt zu unangenehmen Gerüchen. Die tägliche Nutzung des Badezimmers wird dadurch erheblich beeinträchtigt.' }, en: { title: 'Poor Drainage in the Sink', unit: 'Room 4', description: 'The water in the bathroom sink drains very slowly. This causes dirty, standing water to accumulate, and the basin is difficult to clean.', implications: 'Hygiene Issues: A clogged drain is unhygienic and leads to unpleasant odors. It significantly detracts from the daily use of the bathroom.' }, no: { title: 'Dårlig avløp i vasken', unit: 'Rom 4', description: 'Vannet i vasken på badet renner veldig sakte unna. Dette fører til at stillestående, skittent vann samler seg, og vasken er vanskelig å rengjøre.', implications: 'Hygieniske mangler: Et tett avløp er uhygienisk og fører til ubehagelig lukt. Den daglige bruken av badet blir betydelig svekket.' } } }
    ];

    const defectListEl = document.getElementById('defect-list');
    const modalEl = document.getElementById('defect-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const defectForm = document.getElementById('defect-form');
    const addDefectBtn = document.getElementById('add-defect-btn');
    const langButtons = document.querySelectorAll('.lang-switcher button');
    const filterCategoryEl = document.getElementById('filter-category');
    const filterRiskEl = document.getElementById('filter-risk');
    const photoPreviewContainer = document.getElementById('photo-preview-container');
    const photoUploadInput = document.getElementById('photo-upload');
    const generatePdfBtn = document.getElementById('generate-pdf-btn');
    const pdfModalEl = document.getElementById('pdf-modal');
    const pdfModalCloseBtn = document.getElementById('pdf-modal-close-btn');
    const confirmPdfBtn = document.getElementById('confirm-generate-pdf');
    const loaderOverlay = document.getElementById('loader-overlay');
    const statsGrid = document.getElementById('stats-grid');

    const compressImage = (base64Str, maxWidth = 1024, maxHeight = 1024, quality = 0.8) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = (error) => reject(error);
        });
    };

    const saveState = () => {
        try {
            localStorage.setItem('defectAppData', JSON.stringify(state.defects));
        } catch (e) {
            if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                alert('Speicherfehler: Der lokale Speicher des Browsers ist voll, wahrscheinlich aufgrund zu vieler oder zu großer Fotos. Bitte entfernen Sie einige Fotos von Mängeln, um weitermachen zu können.');
            } else {
                console.error("Unbekannter Fehler beim Speichern im Local Storage:", e);
                alert("Ein unbekannter Fehler beim Speichern ist aufgetreten.");
            }
        }
    };

    const loadState = () => {
        try {
            const savedData = localStorage.getItem('defectAppData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (Array.isArray(parsedData)) { state.defects = parsedData; }
                else { state.defects = [...initialDefects]; }
            } else {
                state.defects = [...initialDefects];
            }
        } catch (e) {
            console.error("Fehler beim Laden aus dem Local Storage:", e);
            state.defects = [...initialDefects];
        }
    };

    const translateUI = () => {
        const lang = state.currentLanguage;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (uiTexts[lang][key]) { el.textContent = uiTexts[lang][key]; }
        });
        document.getElementById('modal-title').textContent = state.currentEditId ? uiTexts[lang].editDefect : uiTexts[lang].newDefect;
    };

    const calculateStats = () => ({
        total: state.defects.length,
        boat: state.defects.filter(d => d.category === 'boat').length,
        house: state.defects.filter(d => d.category === 'house').length,
        extremely_high: state.defects.filter(d => d.risk === 'extremely_high').length,
        high: state.defects.filter(d => d.risk === 'high').length,
        medium: state.defects.filter(d => d.risk === 'medium').length,
        low: state.defects.filter(d => d.risk === 'low').length
    });

    const renderStats = () => {
        const stats = calculateStats();
        const lang = state.currentLanguage;
        statsGrid.innerHTML = `
            <div class="stat-item"><div class="stat-number">${stats.total}</div><div class="stat-label">${uiTexts[lang].totalDefects}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.boat}</div><div class="stat-label">${uiTexts[lang].boatDefects}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.house}</div><div class="stat-label">${uiTexts[lang].houseDefects}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.extremely_high}</div><div class="stat-label">${uiTexts[lang].extremelyHighRisk}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.high}</div><div class="stat-label">${uiTexts[lang].highRisk}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.medium}</div><div class="stat-label">${uiTexts[lang].mediumRisk}</div></div>
            <div class="stat-item"><div class="stat-number">${stats.low}</div><div class="stat-label">${uiTexts[lang].lowRisk}</div></div>
        `;
    };

    const renderDefects = () => {
        defectListEl.innerHTML = '';
        const lang = state.currentLanguage;
        const filteredDefects = state.defects.filter(d => 
            (state.filters.category === 'all' || d.category === state.filters.category) &&
            (state.filters.risk === 'all' || d.risk === state.filters.risk)
        );

        if (filteredDefects.length === 0) {
            defectListEl.innerHTML = `<p>Keine Mängel für die gewählten Filter gefunden.</p>`;
            renderStats(); 
            return;
        }

        filteredDefects.forEach(defect => {
            const content = defect.content[lang];
            const riskKey = 'risk' + defect.risk.charAt(0).toUpperCase() + defect.risk.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase());
            const card = document.createElement('div');
            card.className = 'defect-card';
            
            let photosHtml = '';
            const validPhotos = (defect.photos || []).filter(p => p && typeof p === 'string' && p.startsWith('data:image/'));
            if (validPhotos.length > 0) {
                photosHtml = `
                    <div class="photos-in-card">
                        ${validPhotos.slice(0, 4).map((photo, index) => `<img src="${photo}" alt="Mangel Foto ${index + 1}" title="Foto ${index + 1}">`).join('')}
                        ${validPhotos.length > 4 ? `<span class="photo-count">+${validPhotos.length - 4}</span>` : ''}
                    </div>`;
            }
            
            card.innerHTML = `
                <div class="defect-card-header"><h3>${content.title}</h3><p class="unit">${content.unit || ''}</p></div>
                <div class="defect-card-body">
                    <strong>${uiTexts[lang].description}:</strong><p>${content.description}</p><br>
                    <strong>${uiTexts[lang].implications}:</strong><p>${content.implications}</p>
                    ${photosHtml}
                    <span class="risk-assessment risk-${defect.risk}">${uiTexts[lang][riskKey]}</span>
                </div>
                <div class="defect-card-footer">
                    <button class="button edit-btn" data-id="${defect.id}">${uiTexts[lang].edit}</button>
                    <button class="button danger delete-btn" data-id="${defect.id}">${uiTexts[lang].delete}</button>
                </div>`;
            defectListEl.appendChild(card);
        });

        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
        renderStats();
    };
    
    const toBase64 = (file) => new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) return reject(new Error('Ungültiges Bildformat'));
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
    
    const renderPhotoPreview = (photoData, index) => {
        const pWrap = document.createElement('div');
        pWrap.className = 'photo-preview';
        const img = document.createElement('img');
        img.src = photoData;
        img.alt = `Vorschau ${index + 1}`;
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-photo-btn';
        delBtn.innerHTML = '&times;';
        delBtn.type = 'button';
        delBtn.title = 'Foto entfernen';
        delBtn.onclick = (e) => {
            e.preventDefault();
            state.currentEditPhotos.splice(index, 1);
            photoPreviewContainer.innerHTML = '';
            state.currentEditPhotos.forEach((photo, newIndex) => renderPhotoPreview(photo, newIndex));
        };
        pWrap.appendChild(img);
        pWrap.appendChild(delBtn);
        photoPreviewContainer.appendChild(pWrap);
    };

    const handlePhotoUpload = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        loaderOverlay.style.display = 'flex';
        for (const file of files) {
            try {
                const base64Data = await toBase64(file);
                const compressedBase64 = await compressImage(base64Data);
                state.currentEditPhotos.push(compressedBase64);
                renderPhotoPreview(compressedBase64, state.currentEditPhotos.length - 1);
            } catch (error) {
                console.error(`Fehler bei Datei "${file.name}":`, error);
                alert(`Konnte Foto nicht verarbeiten: ${file.name}\n${error.message}`);
            }
        }
        e.target.value = '';
        loaderOverlay.style.display = 'none';
    };

    const openModal = (defectId = null) => {
        state.currentEditId = defectId;
        defectForm.reset();
        photoPreviewContainer.innerHTML = '';
        
        const lang = state.currentLanguage;
        document.getElementById('modal-title').textContent = defectId ? uiTexts[lang].editDefect : uiTexts[lang].newDefect;

        if (defectId) {
            const defect = state.defects.find(d => d.id === defectId);
            if (defect) {
                document.getElementById('defect-id').value = defect.id;
                document.getElementById('defect-category').value = defect.category;
                document.getElementById('defect-risk').value = defect.risk;
                ['de', 'en', 'no'].forEach(l => {
                    const c = defect.content[l] || {};
                    document.getElementById(`defect-title-${l}`).value = c.title || '';
                    document.getElementById(`defect-unit-${l}`).value = c.unit || '';
                    document.getElementById(`defect-desc-${l}`).value = c.description || '';
                    document.getElementById(`defect-impl-${l}`).value = c.implications || '';
                });
                state.currentEditPhotos = defect.photos ? [...defect.photos] : [];
                state.currentEditPhotos.forEach((photo, index) => renderPhotoPreview(photo, index));
            }
        } else {
            state.currentEditPhotos = [];
            document.getElementById('defect-id').value = '';
        }
        modalEl.style.display = 'block';
    };

    const closeModal = () => {
        modalEl.style.display = 'none';
        state.currentEditId = null;
        state.currentEditPhotos = [];
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        const defectData = {
            id: document.getElementById('defect-id').value || `defect_${Date.now()}`,
            category: document.getElementById('defect-category').value,
            risk: document.getElementById('defect-risk').value,
            photos: state.currentEditPhotos,
            content: {
                de: { title: document.getElementById('defect-title-de').value.trim(), unit: document.getElementById('defect-unit-de').value.trim(), description: document.getElementById('defect-desc-de').value.trim(), implications: document.getElementById('defect-impl-de').value.trim() },
                en: { title: document.getElementById('defect-title-en').value.trim(), unit: document.getElementById('defect-unit-en').value.trim(), description: document.getElementById('defect-desc-en').value.trim(), implications: document.getElementById('defect-impl-en').value.trim() },
                no: { title: document.getElementById('defect-title-no').value.trim(), unit: document.getElementById('defect-unit-no').value.trim(), description: document.getElementById('defect-desc-no').value.trim(), implications: document.getElementById('defect-impl-no').value.trim() }
            }
        };

        if (state.currentEditId) {
            const index = state.defects.findIndex(d => d.id === state.currentEditId);
            if (index > -1) state.defects[index] = defectData;
            else state.defects.push(defectData);
        } else {
            state.defects.push(defectData);
        }
        saveState();
        renderDefects();
        closeModal();
    };

    const handleEditClick = (e) => openModal(e.target.dataset.id);

    const handleDeleteClick = (e) => {
        if (confirm(uiTexts[state.currentLanguage].confirmDelete)) {
            state.defects = state.defects.filter(d => d.id !== e.target.dataset.id);
            saveState();
            renderDefects();
        }
    };

    class SignaturePad {
        constructor(canvas) { this.canvas = canvas; this.ctx = canvas.getContext('2d'); this.isDrawing = false; this.signed = false; this.setupCanvas(); this.bindEvents(); }
        setupCanvas() { const rect = this.canvas.getBoundingClientRect(); const dpr = window.devicePixelRatio || 1; this.canvas.width = rect.width * dpr; this.canvas.height = rect.height * dpr; this.canvas.style.width = `${rect.width}px`; this.canvas.style.height = `${rect.height}px`; this.ctx.scale(dpr, dpr); this.ctx.strokeStyle = '#000000'; this.ctx.lineWidth = 2.5; this.ctx.lineJoin = 'round'; this.ctx.lineCap = 'round'; this.clear(); }
        bindEvents() {
            this.handleMove = this.handleMove.bind(this);
            this.handleEnd = this.handleEnd.bind(this);
            this.canvas.addEventListener('mousedown', e => this.handleStart(e));
            this.canvas.addEventListener('touchstart', e => { e.preventDefault(); this.handleStart(e.touches[0]); });
        }
        getCoordinates(event) { const rect = this.canvas.getBoundingClientRect(); return { x: event.clientX - rect.left, y: event.clientY - rect.top }; }
        handleStart(event) {
            this.isDrawing = true; this.signed = true;
            const coords = this.getCoordinates(event);
            this.ctx.beginPath(); this.ctx.moveTo(coords.x, coords.y); this.ctx.lineTo(coords.x, coords.y); this.ctx.stroke();
            this.lastPos = coords;
            this.canvas.addEventListener('mousemove', this.handleMove);
            this.canvas.addEventListener('touchmove', this.handleMove);
            this.canvas.addEventListener('mouseup', this.handleEnd);
            this.canvas.addEventListener('touchend', this.handleEnd);
        }
        handleMove(event) {
            if (!this.isDrawing) return;
            const coords = this.getCoordinates(event.touches ? event.touches[0] : event);
            this.ctx.beginPath(); this.ctx.moveTo(this.lastPos.x, this.lastPos.y); this.ctx.lineTo(coords.x, coords.y); this.ctx.stroke();
            this.lastPos = coords;
        }
        handleEnd() {
            this.isDrawing = false;
            this.canvas.removeEventListener('mousemove', this.handleMove);
            this.canvas.removeEventListener('touchmove', this.handleMove);
            this.canvas.removeEventListener('mouseup', this.handleEnd);
            this.canvas.removeEventListener('touchend', this.handleEnd);
        }
        clear() { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.signed = false; this.ctx.fillStyle = '#FFFFFF'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); }
        toDataURL() { return this.signed ? this.canvas.toDataURL('image/png') : null; }
        resizeCanvas() { const data = this.toDataURL(); this.setupCanvas(); if (data) { const img = new Image(); img.onload = () => {this.ctx.drawImage(img, 0, 0); this.signed = true;}; img.src = data; } }
    }

    let landlordPad, tenantPad;
    const openPdfModal = () => {
        pdfModalEl.style.display = 'block';
        if (!landlordPad) {
            landlordPad = new SignaturePad(document.getElementById('signature-landlord'));
            tenantPad = new SignaturePad(document.getElementById('signature-tenant'));
            document.getElementById('clear-landlord-sig').addEventListener('click', () => landlordPad.clear());
            document.getElementById('clear-tenant-sig').addEventListener('click', () => tenantPad.clear());
        } else {
            landlordPad.clear(); tenantPad.clear();
            landlordPad.resizeCanvas(); tenantPad.resizeCanvas();
        }
    };
    const closePdfModal = () => pdfModalEl.style.display = 'none';

    // --- KORRIGIERTE UND OPTIMIERTE PDF-GENERIERUNG MIT VOLLSTÄNDIGER BILDUNTERSTÜTZUNG ---
    const generatePdf = async () => {
        loaderOverlay.style.display = 'flex';
        await new Promise(resolve => setTimeout(resolve, 50));

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const languages = ['de', 'en', 'no'];
            const pageMargin = 15;
            const contentWidth = doc.internal.pageSize.getWidth() - 2 * pageMargin;
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Hilfsfunktion für weitere Komprimierung der Bilder für PDF
            const compressImageForPdf = async (base64Str, maxWidth = 600, maxHeight = 600, quality = 0.6) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = base64Str;
                });
            };
            
            const addPageHeaderAndFooter = (lang, pageNum, totalPages) => {
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text(`${uiTexts[lang].page} ${pageNum} ${uiTexts[lang].of} ${totalPages}`, 
                    doc.internal.pageSize.getWidth() / 2, pageHeight - 10, { align: 'center' });
            };

            // Generiere PDF für jede Sprache
            for (let langIdx = 0; langIdx < languages.length; langIdx++) {
                const lang = languages[langIdx];
                if (langIdx > 0) doc.addPage();
                
                let yPos = pageMargin;
                let currentPageNum = doc.internal.getNumberOfPages();

                // Titel und Datum
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0);
                doc.text(uiTexts[lang].reportTitle, doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`${uiTexts[lang].date}: ${new Date().toLocaleDateString(lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-US' : 'nb-NO')}`, pageMargin, yPos);
                yPos += 12;

                // Defekte verarbeiten
                for (let defectIdx = 0; defectIdx < state.defects.length; defectIdx++) {
                    const defect = state.defects[defectIdx];
                    const content = defect.content[lang];
                    if (!content || !content.title) continue;
                    
                    const riskKey = 'risk' + defect.risk.charAt(0).toUpperCase() + defect.risk.slice(1).replace(/_([a-z])/g, g => g[1].toUpperCase());
                    
                    // Texte vorbereiten
                    const titleLines = doc.splitTextToSize(content.title || '', contentWidth);
                    const descLines = doc.splitTextToSize(content.description || '', contentWidth - 5);
                    const implLines = doc.splitTextToSize(content.implications || '', contentWidth - 5);
                    
                    // Bilder vorbereiten und komprimieren
                    const validPhotos = (defect.photos || []).filter(p => p && typeof p === 'string' && p.startsWith('data:image/'));
                    const compressedPhotos = [];
                    
                    for (const photo of validPhotos) {
                        try {
                            const compressed = await compressImageForPdf(photo);
                            compressedPhotos.push(compressed);
                        } catch (err) {
                            console.error('Fehler beim Komprimieren des Fotos:', err);
                        }
                    }
                    
                    // Berechne benötigte Höhe
                    const photoRows = Math.ceil(compressedPhotos.length / 3);
                    const photoSectionHeight = compressedPhotos.length > 0 ? (photoRows * 45) + 15 : 0;
                    const totalDefectHeight = (titleLines.length * 6) + (descLines.length * 5) + 
                                            (implLines.length * 5) + photoSectionHeight + 40;

                    // Prüfe ob neue Seite benötigt wird
                    if (yPos + totalDefectHeight > pageHeight - pageMargin) {
                        doc.addPage();
                        yPos = pageMargin;
                        currentPageNum++;
                    }
                    
                    // Trennlinie
                    doc.setDrawColor(180);
                    doc.line(pageMargin, yPos, contentWidth + pageMargin, yPos);
                    yPos += 8;
                    
                    // Titel
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0);
                    doc.text(titleLines, pageMargin, yPos);
                    yPos += titleLines.length * 6 + 2;
                    
                    // Einheit und Risiko
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(100);
                    doc.text(`${uiTexts[lang].affectedUnit}: ${content.unit || '-'}`, pageMargin, yPos);
                    
                    const riskColor = {
                        extremely_high: [125, 0, 0],
                        high: [217, 83, 79],
                        medium: [240, 173, 78],
                        low: [92, 184, 92]
                    };
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...(riskColor[defect.risk] || [0, 0, 0]));
                    doc.text(`${uiTexts[lang].risk}: ${uiTexts[lang][riskKey]}`, contentWidth + pageMargin, yPos, { align: 'right' });
                    doc.setTextColor(0);
                    yPos += 8;
                    
                    // Beschreibung
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${uiTexts[lang].description}:`, pageMargin, yPos);
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.text(descLines, pageMargin + 5, yPos);
                    yPos += descLines.length * 5 + 5;
                    
                    // Implikationen
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${uiTexts[lang].implications}:`, pageMargin, yPos);
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.text(implLines, pageMargin + 5, yPos);
                    yPos += implLines.length * 5 + 10;
                    
                    // Fotos hinzufügen
                    if (compressedPhotos.length > 0) {
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${uiTexts[lang].addPhotos} (${compressedPhotos.length}):`, pageMargin, yPos);
                        yPos += 8;
                        
                        let xPos = pageMargin;
                        const photoWidth = 40;
                        const photoHeight = 40;
                        const photoSpacing = 10;
                        
                        for (let pIdx = 0; pIdx < compressedPhotos.length; pIdx++) {
                            // Neue Zeile nach 3 Fotos
                            if (pIdx > 0 && pIdx % 3 === 0) {
                                xPos = pageMargin;
                                yPos += photoHeight + photoSpacing;
                            }
                            
                            // Prüfe ob neue Seite benötigt wird
                            if (yPos + photoHeight > pageHeight - pageMargin) {
                                doc.addPage();
                                yPos = pageMargin;
                                xPos = pageMargin;
                                currentPageNum++;
                            }
                            
                            try {
                                // Füge das Foto zum PDF hinzu
                                doc.addImage(compressedPhotos[pIdx], 'JPEG', xPos, yPos, photoWidth, photoHeight);
                                
                                // Rahmen um das Foto
                                doc.setDrawColor(200);
                                doc.rect(xPos, yPos, photoWidth, photoHeight);
                            } catch (imgError) {
                                console.error('Fehler beim Hinzufügen des Bildes zum PDF:', imgError);
                                // Platzhalter bei Fehler
                                doc.setDrawColor(255, 0, 0);
                                doc.rect(xPos, yPos, photoWidth, photoHeight);
                                doc.setFontSize(8);
                                doc.text('Bildfehler', xPos + photoWidth/2, yPos + photoHeight/2, { align: 'center' });
                            }
                            
                            xPos += photoWidth + photoSpacing;
                        }
                        
                        yPos += photoHeight + 15;
                    }
                    
                    yPos += 5;
                }
            }

            // Unterschriftenseite hinzufügen
            doc.addPage();
            let sigYPos = 40;
            const sigWidth = 80;
            const sigHeight = 40;
            
            // Überschrift für Unterschriftenseite
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(uiTexts.de.protocolAndSignature, doc.internal.pageSize.getWidth() / 2, sigYPos, { align: 'center' });
            sigYPos += 10;
            
            doc.setFontSize(14);
            doc.text(uiTexts.en.protocolAndSignature, doc.internal.pageSize.getWidth() / 2, sigYPos, { align: 'center' });
            sigYPos += 10;
            
            doc.text(uiTexts.no.protocolAndSignature, doc.internal.pageSize.getWidth() / 2, sigYPos, { align: 'center' });
            sigYPos += 50;
            
            // Vermieter Unterschrift
            const landlordSigData = landlordPad.toDataURL();
            if (landlordSigData) {
                try {
                    doc.addImage(landlordSigData, 'PNG', pageMargin, sigYPos, sigWidth, sigHeight);
                } catch (err) {
                    console.error('Fehler beim Hinzufügen der Vermieter-Unterschrift:', err);
                }
            }
            doc.setDrawColor(0);
            doc.line(pageMargin, sigYPos + sigHeight + 2, pageMargin + sigWidth, sigYPos + sigHeight + 2);
            doc.setFontSize(10);
            doc.text(`${uiTexts.de.landlordSignature} / ${uiTexts.en.landlordSignature} / ${uiTexts.no.landlordSignature}`, 
                pageMargin, sigYPos + sigHeight + 8);
            
            // Mieter Unterschrift
            const tenantSigData = tenantPad.toDataURL();
            if (tenantSigData) {
                try {
                    doc.addImage(tenantSigData, 'PNG', contentWidth + pageMargin - sigWidth, sigYPos, sigWidth, sigHeight);
                } catch (err) {
                    console.error('Fehler beim Hinzufügen der Mieter-Unterschrift:', err);
                }
            }
            doc.line(contentWidth + pageMargin - sigWidth, sigYPos + sigHeight + 2, contentWidth + pageMargin, sigYPos + sigHeight + 2);
            doc.text(`${uiTexts.de.tenantSignature} / ${uiTexts.en.tenantSignature} / ${uiTexts.no.tenantSignature}`, 
                contentWidth + pageMargin - sigWidth, sigYPos + sigHeight + 8);

            // Seitenzahlen hinzufügen
            const totalPages = doc.internal.getNumberOfPages();
            for (let j = 1; j <= totalPages; j++) {
                doc.setPage(j);
                addPageHeaderAndFooter('de', j, totalPages);
            }
            
            // PDF speichern
            const fileName = `Mängelprotokoll_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);

        } catch (error) {
            console.error('Kritischer Fehler bei PDF-Generierung:', error);
            alert('Fehler bei der PDF-Erstellung: ' + error.message + '\n\nBitte versuchen Sie es erneut oder reduzieren Sie die Anzahl/Größe der Fotos.');
        } finally {
            loaderOverlay.style.display = 'none';
            closePdfModal();
        }
    };

    // Event Listeners
    langButtons.forEach(button => button.addEventListener('click', () => {
        state.currentLanguage = button.id.split('-')[1];
        langButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        translateUI();
        renderDefects();
    }));
    
    addDefectBtn.addEventListener('click', () => openModal());
    modalCloseBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => {
        if (e.target === modalEl) closeModal();
        if (e.target === pdfModalEl) closePdfModal();
    });
    defectForm.addEventListener('submit', handleFormSubmit);
    filterCategoryEl.addEventListener('change', (e) => {
        state.filters.category = e.target.value;
        renderDefects();
    });
    filterRiskEl.addEventListener('change', (e) => {
        state.filters.risk = e.target.value;
        renderDefects();
    });
    photoUploadInput.addEventListener('change', handlePhotoUpload);
    generatePdfBtn.addEventListener('click', openPdfModal);
    pdfModalCloseBtn.addEventListener('click', closePdfModal);
    confirmPdfBtn.addEventListener('click', generatePdf);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (modalEl.style.display === 'block') closeModal();
            if (pdfModalEl.style.display === 'block') closePdfModal();
        }
    });

    // Initialisierung
    const init = () => {
        loadState();
        translateUI();
        renderDefects();
    };
    
    init();
});
</script>
</body>
</html>